<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1400">
    <title>VisaD Vault - Accounts</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-50: #eef2ff;
            --primary-100: #e0e7ff;
            --primary-200: #c7d2fe;
            --primary-400: #818cf8;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --primary-700: #4338ca;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --emerald-100: #d1fae5;
            --emerald-500: #10b981;
            --emerald-600: #059669;
            --emerald-700: #047857;
            --rose-100: #ffe4e6;
            --rose-500: #f43f5e;
            --rose-600: #e11d48;
            --rose-700: #be123c;
            --cyan-100: #cffafe;
            --cyan-500: #06b6d4;
            --cyan-600: #0891b2;
            --amber-500: #f59e0b;

            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-default: #e2e8f0;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body.dark-theme {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-default: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h1 {
            color: white;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .toolbar {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-default);
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 14px;
            border: 2px solid var(--border-default);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-width: 140px;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-500);
        }

        .filter-group.search input {
            min-width: 250px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
        }

        .btn-secondary {
            background: var(--slate-200);
            color: var(--slate-700);
        }

        body.dark-theme .btn-secondary {
            background: var(--slate-700);
            color: var(--slate-200);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600));
            color: white;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (max-width: 1400px) {
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .summary-card {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 24px;
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
        }

        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .summary-card.total .summary-icon {
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .summary-card.revenue .summary-icon {
            background: var(--cyan-100);
            color: var(--cyan-600);
        }

        .summary-card.paid .summary-icon {
            background: var(--emerald-100);
            color: var(--emerald-600);
        }

        .summary-card.unpaid .summary-icon {
            background: var(--rose-100);
            color: var(--rose-600);
        }

        .summary-card.full-refund .summary-icon {
            background: #fee2e2;
            color: #dc2626;
        }

        .summary-card.partial-refund .summary-icon {
            background: #fef3c7;
            color: #d97706;
        }

        body.dark-theme .summary-card.total .summary-icon {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-400);
        }

        body.dark-theme .summary-card.revenue .summary-icon {
            background: rgba(6, 182, 212, 0.2);
            color: var(--cyan-500);
        }

        body.dark-theme .summary-card.paid .summary-icon {
            background: rgba(16, 185, 129, 0.2);
            color: var(--emerald-500);
        }

        body.dark-theme .summary-card.unpaid .summary-icon {
            background: rgba(244, 63, 94, 0.2);
            color: var(--rose-500);
        }

        body.dark-theme .summary-card.full-refund .summary-icon {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        body.dark-theme .summary-card.partial-refund .summary-icon {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 800;
        }

        .summary-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .table-wrapper {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-default);
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--bg-tertiary);
        }

        .data-table th {
            padding: 16px 14px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 2px solid var(--border-default);
            cursor: pointer;
            white-space: nowrap;
        }

        .data-table th:hover {
            color: var(--primary-500);
        }

        .data-table th i {
            margin-left: 6px;
            font-size: 10px;
            opacity: 0.5;
        }

        .data-table th.sorted i {
            opacity: 1;
            color: var(--primary-500);
        }

        .data-table td {
            padding: 16px 14px;
            font-size: 14px;
            border-bottom: 1px solid var(--border-default);
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .invoice-num {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--primary-600);
        }

        body.dark-theme .invoice-num {
            color: var(--primary-400);
        }

        .customer-info .name {
            font-weight: 600;
        }

        .customer-info .email {
            font-size: 12px;
            color: var(--text-muted);
        }

        .amount {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-badge.paid {
            background: var(--emerald-100);
            color: var(--emerald-700);
        }

        .status-badge.unpaid {
            background: var(--rose-100);
            color: var(--rose-700);
        }

        .status-badge.full-refund {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-badge.partial-refund {
            background: #fef3c7;
            color: #d97706;
        }

        body.dark-theme .status-badge.paid {
            background: rgba(16, 185, 129, 0.2);
            color: var(--emerald-500);
        }

        body.dark-theme .status-badge.unpaid {
            background: rgba(244, 63, 94, 0.2);
            color: var(--rose-500);
        }

        body.dark-theme .status-badge.full-refund {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        body.dark-theme .status-badge.partial-refund {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .action-btns button {
            padding: 8px 14px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-btn {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .view-btn:hover {
            background: var(--primary-200);
        }

        body.dark-theme .view-btn {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-400);
        }

        .pdf-btn {
            background: var(--emerald-100);
            color: var(--emerald-700);
        }

        body.dark-theme .pdf-btn {
            background: rgba(16, 185, 129, 0.2);
            color: var(--emerald-500);
        }

        .loading,
        .empty {
            padding: 80px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .loading i,
        .empty i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading i {
            color: var(--primary-500);
            opacity: 1;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-default);
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-muted);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pagination-btn {
            padding: 10px 14px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 20000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600));
        }

        .toast.error {
            background: linear-gradient(135deg, var(--rose-500), var(--rose-600));
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--amber-500), #d97706);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Invoice Modal Styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .invoice-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlide 0.3s ease;
            overflow: hidden;
        }

        body.dark-theme .invoice-modal {
            background: var(--slate-800);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--slate-800), var(--slate-900));
            border-bottom: 1px solid var(--border-default);
        }

        .modal-header h2 {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-modal {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-modal.download {
            background: var(--emerald-500);
            color: white;
        }

        .btn-modal.download:hover {
            background: var(--emerald-600);
        }

        .btn-modal.email {
            background: var(--primary-500);
            color: white;
        }

        .btn-modal.email:hover {
            background: var(--primary-600);
        }

        .btn-modal.close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 24px;
            width: 36px;
            height: 36px;
            padding: 0;
            justify-content: center;
            border-radius: 50%;
        }

        .btn-modal.close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--slate-100);
        }

        body.dark-theme .modal-body {
            background: var(--slate-900);
        }

        .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--slate-800);
            padding: 40px;
            border-radius: var(--radius-lg);
            color: var(--slate-100);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--slate-700);
        }

        .invoice-logo img {
            width: 120px;
        }

        .invoice-title {
            font-size: 28px;
            font-weight: 300;
            margin-top: 10px;
            color: var(--slate-100);
        }

        .invoice-company {
            text-align: right;
        }

        .invoice-company-name {
            font-weight: 700;
            color: var(--primary-400);
            font-size: 16px;
            margin-bottom: 8px;
        }

        .invoice-company p {
            font-size: 12px;
            color: var(--slate-400);
            margin: 2px 0;
        }

        .invoice-number-box {
            text-align: center;
            margin: 30px 0;
        }

        .invoice-number-inner {
            display: inline-block;
            border: 2px solid var(--slate-100);
            border-radius: 8px;
            padding: 12px 30px;
        }

        .invoice-number-label {
            font-size: 10px;
            color: var(--slate-400);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .invoice-number-value {
            font-size: 20px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .invoice-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }

        .invoice-billto h3 {
            font-size: 10px;
            color: var(--slate-400);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .invoice-billto .cust-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .invoice-billto p {
            font-size: 13px;
            color: var(--slate-400);
            margin: 2px 0;
        }

        .invoice-meta {
            text-align: right;
        }

        .invoice-meta-row {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .invoice-meta-label {
            color: var(--slate-400);
            margin-right: 15px;
        }

        .invoice-meta-value {
            font-weight: 600;
            min-width: 100px;
            text-align: right;
        }

        .invoice-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .invoice-status.paid {
            background: rgba(16, 185, 129, 0.2);
            color: var(--emerald-500);
        }

        .invoice-status.unpaid {
            background: rgba(244, 63, 94, 0.2);
            color: var(--rose-500);
        }

        .invoice-status.full-refund {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .invoice-status.partial-refund {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        .invoice-table th {
            padding: 12px 10px;
            text-align: left;
            font-size: 10px;
            color: var(--slate-400);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--slate-700);
        }

        .invoice-table td {
            padding: 15px 10px;
            font-size: 13px;
            border-bottom: 1px solid var(--slate-700);
        }

        .invoice-table .item-desc small {
            color: var(--slate-400);
        }

        .invoice-totals {
            margin-left: auto;
            width: 250px;
        }

        .invoice-total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 13px;
            color: var(--slate-400);
        }

        .invoice-total-row.discount {
            color: var(--emerald-500);
            background: rgba(16, 185, 129, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 8px 0;
        }

        .invoice-total-row.discount span:last-child {
            font-weight: 700;
        }

        .invoice-total-row.refund {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
        }

        .invoice-total-row.refund span:last-child {
            font-weight: 700;
        }

        .invoice-total-row.final {
            border-top: 2px solid var(--slate-100);
            padding-top: 15px;
            margin-top: 10px;
            font-size: 18px;
            font-weight: 700;
            color: var(--slate-100);
        }

        .invoice-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--slate-700);
            text-align: center;
            color: var(--slate-400);
            font-size: 12px;
        }

        .invoice-footer p {
            margin: 5px 0;
        }

        .invoice-footer .paid-msg {
            color: var(--emerald-500);
            font-weight: 600;
        }

        .invoice-footer .refund-msg {
            color: #f59e0b;
            font-weight: 600;
        }

        /* Travelers List Styles */
        .travelers-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
        }

        .traveler-row {
            padding: 10px 12px;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            border-left: 3px solid var(--primary-500);
        }

        .traveler-row.co-traveler {
            border-left-color: var(--cyan-500);
        }

        .traveler-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .traveler-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .traveler-badge.main {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .traveler-badge.co {
            background: var(--cyan-100);
            color: var(--cyan-600);
        }

        body.dark-theme .traveler-badge.main {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-400);
        }

        body.dark-theme .traveler-badge.co {
            background: rgba(6, 182, 212, 0.2);
            color: var(--cyan-500);
        }

        .traveler-price {
            font-size: 13px;
            font-weight: 700;
            color: var(--emerald-600);
            font-family: 'JetBrains Mono', monospace;
            margin-left: auto;
        }

        body.dark-theme .traveler-price {
            color: var(--emerald-500);
        }

        .traveler-service {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .traveler-service i {
            color: var(--primary-500);
            margin-right: 4px;
            width: 14px;
        }

        .traveler-visa {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .traveler-visa i {
            color: var(--emerald-500);
            margin-right: 4px;
            width: 14px;
        }

        .traveler-count {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .traveler-count i {
            margin-right: 4px;
        }

        /* Amount Breakdown Styles */
        .amount-breakdown {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .amount-total {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .amount-subtotal {
            font-size: 11px;
            color: var(--text-muted);
        }

        .amount-discount {
            font-size: 11px;
            color: var(--emerald-600);
            font-weight: 600;
            background: rgba(16, 185, 129, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }

        .amount-discount i {
            margin-right: 4px;
        }

        body.dark-theme .amount-discount {
            color: var(--emerald-400);
            background: rgba(16, 185, 129, 0.15);
        }

        .refund-amount {
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
        }

        .refund-amount.full {
            color: #dc2626;
            background: rgba(239, 68, 68, 0.1);
        }

        .refund-amount.partial {
            color: #d97706;
            background: rgba(245, 158, 11, 0.1);
        }

        body.dark-theme .refund-amount.full {
            color: #f87171;
            background: rgba(239, 68, 68, 0.15);
        }

        body.dark-theme .refund-amount.partial {
            color: #fbbf24;
            background: rgba(245, 158, 11, 0.15);
        }

        .no-refund {
            color: var(--text-muted);
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="page-header">
        <h1><i class="fas fa-file-invoice-dollar"></i> Accounts - Invoice Management</h1>
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>

    <div class="page-container">
        <div class="toolbar">
            <div class="filters">
                <div class="filter-group">
                    <label>From Date</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="filter-group">
                    <label>To Date</label>
                    <input type="date" id="toDate">
                </div>
                <div class="filter-group">
                    <label>Quick Filter</label>
                    <select id="quickFilter">
                        <option value="all" selected>All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="lastmonth">Last Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Payment Status</label>
                    <select id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="Paid">Paid</option>
                        <option value="Unpaid">Unpaid</option>
                        <option value="Full Refund">Full Refund</option>
                        <option value="Partial Refund">Partial Refund</option>
                    </select>
                </div>
                <div class="filter-group search">
                    <label>Search</label>
                    <input type="text" id="searchInput" placeholder="Search name, invoice #...">
                </div>
                <button class="btn btn-secondary" id="resetBtn"><i class="fas fa-undo"></i> Reset</button>
                <button class="btn btn-primary" id="saveAllInvoicesBtn"><i class="fas fa-save"></i> Save All
                    Invoices</button>
                <button class="btn btn-success" id="exportBtn"><i class="fas fa-file-csv"></i> Export CSV</button>
            </div>
        </div>

        <div class="summary-grid">
            <div class="summary-card total">
                <div class="summary-icon"><i class="fas fa-file-invoice"></i></div>
                <div>
                    <div class="summary-value" id="totalCount">0</div>
                    <div class="summary-label">Total Invoices</div>
                </div>
            </div>
            <div class="summary-card revenue">
                <div class="summary-icon"><i class="fas fa-pound-sign"></i></div>
                <div>
                    <div class="summary-value" id="totalRevenue">£0.00</div>
                    <div class="summary-label">Total Revenue</div>
                </div>
            </div>
            <div class="summary-card paid">
                <div class="summary-icon"><i class="fas fa-check-circle"></i></div>
                <div>
                    <div class="summary-value" id="paidAmount">£0.00</div>
                    <div class="summary-label">Paid Amount</div>
                </div>
            </div>
            <div class="summary-card unpaid">
                <div class="summary-icon"><i class="fas fa-clock"></i></div>
                <div>
                    <div class="summary-value" id="unpaidAmount">£0.00</div>
                    <div class="summary-label">Outstanding</div>
                </div>
            </div>
            <div class="summary-card full-refund">
                <div class="summary-icon"><i class="fas fa-undo"></i></div>
                <div>
                    <div class="summary-value" id="fullRefundAmount">£0.00</div>
                    <div class="summary-label">Full Refunds</div>
                </div>
            </div>
            <div class="summary-card partial-refund">
                <div class="summary-icon"><i class="fas fa-undo-alt"></i></div>
                <div>
                    <div class="summary-value" id="partialRefundAmount">£0.00</div>
                    <div class="summary-label">Partial Refunds</div>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th data-sort="invoice_number">Invoice # <i class="fas fa-sort"></i></th>
                        <th data-sort="customer_name">Customer <i class="fas fa-sort"></i></th>
                        <th>Travelers & Services</th>
                        <th data-sort="invoice_date">Invoice Date <i class="fas fa-sort"></i></th>
                        <th data-sort="total_amount">Amount <i class="fas fa-sort"></i></th>
                        <th data-sort="refund_amount">Refund <i class="fas fa-sort"></i></th>
                        <th data-sort="payment_status">Status <i class="fas fa-sort"></i></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div class="loading" id="loadingState"><i class="fas fa-spinner fa-spin"></i>
                <p>Loading invoices...</p>
            </div>
            <div class="empty" id="emptyState" style="display:none;"><i class="fas fa-inbox"></i>
                <h3>No Invoices Found</h3>
                <p>Try adjusting your filters</p>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="paginationInfo">Showing 0-0 of 0</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prevBtn" disabled><i class="fas fa-chevron-left"></i>
                        Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button class="pagination-btn" id="nextBtn" disabled>Next <i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-backdrop" id="invoiceModal">
        <div class="invoice-modal">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice"></i> <span id="modalTitle">Invoice</span></h2>
                <div class="modal-actions">
                    <button class="btn-modal download" id="modalDownloadBtn"><i class="fas fa-file-pdf"></i> Download
                        PDF</button>
                    <button class="btn-modal email" id="modalEmailBtn"><i class="fas fa-envelope"></i> Email</button>
                    <button class="btn-modal close" id="modalCloseBtn">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="invoiceModalBody">
                <!-- Invoice content loads here -->
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="auth.js"></script>
    <script>
        $(document).ready(async function () {
            // Require admin authentication
            const session = await VaultAuth.requireAuth('admin');
            if (!session) return; // Will redirect if not authenticated

            // Continue with initialization
            init();

            let allData = [], filtered = [], page = 1, perPage = 20, sortCol = 'invoice_number', sortDir = 'desc';

            if (localStorage.getItem('theme') === 'dark') $('body').addClass('dark-theme');

            function init() { loadData(); bindEvents(); }

            function loadData() {
                $('#loadingState').show();
                $('#tableBody').empty();
                $('#emptyState').hide();

                console.log('Loading data from API...');

                VaultAuth.apiCall({
                    url: VaultAuth.API_BASE_URL + '/travelers?page=1&limit=9999&summary=false',
                    method: 'GET'
                }).done(function (res) {
                    console.log('API Response:', res);
                    $('#loadingState').hide();
                    if (res.status === 'success' && res.data && res.data.length > 0) {
                        console.log('Found ' + res.data.length + ' travelers');

                        // Function to calculate price based on package
                        function getPriceFromPackage(pkg) {
                            if (!pkg) return 149.00;
                            var pkgLower = pkg.toLowerCase();
                            if (pkgLower.indexOf('appointment only') >= 0) {
                                return 99.00;
                            } else if (pkgLower.indexOf('fast track full support') >= 0 || (pkgLower.indexOf('fast track') >= 0 && pkgLower.indexOf('full support') >= 0)) {
                                return 349.00;
                            } else if (pkgLower.indexOf('fast track appointment') >= 0) {
                                return 199.00;
                            } else if (pkgLower.indexOf('full support') >= 0) {
                                return 149.00;
                            }
                            return 149.00;
                        }

                        // Function to calculate discount based on type
                        function calcDiscount(subtotal, discType, discValue) {
                            if (!discType || discType === 'none' || discType === 'Select' || !discValue) return 0;
                            var val = parseFloat(discValue) || 0;
                            if (discType === 'percentage') {
                                return (subtotal * val) / 100;
                            } else if (discType === 'fixed') {
                                return val;
                            }
                            return 0;
                        }

                        allData = res.data.map(function (t) {
                            var travelers = [];

                            // Check if invoice exists in invoices table
                            var savedInvoice = t.saved_invoice || null;
                            var invoiceLocked = savedInvoice && savedInvoice.id;
                            var savedItems = [];

                            if (invoiceLocked && savedInvoice.items_json) {
                                try {
                                    savedItems = JSON.parse(savedInvoice.items_json);
                                } catch (e) {
                                    console.warn('Could not parse saved invoice items for ID:', t.id);
                                }
                            }

                            // Main traveler
                            var mainName = [t.first_name, t.last_name].filter(Boolean).join(' ') || t.fullname || t.name || 'Unknown';
                            var mainService = t.package || 'Full Support';
                            var mainPrice;

                            // Use saved price if invoice is locked
                            if (invoiceLocked && savedItems.length > 0) {
                                var mainItem = savedItems.find(function (item) { return item.type === 'main'; });
                                mainPrice = mainItem ? parseFloat(mainItem.price) : getPriceFromPackage(mainService);
                            } else {
                                mainPrice = parseFloat(t.price) > 0 ? parseFloat(t.price) : getPriceFromPackage(mainService);
                            }

                            var subtotal = mainPrice;

                            travelers.push({
                                name: mainName,
                                type: 'Main',
                                service: mainService,
                                visa_type: t.visa_type || '',
                                visa_country: t.visa_country || '',
                                price: mainPrice
                            });

                            // Co-travelers
                            if (t.dependents && t.dependents.length > 0) {
                                t.dependents.forEach(function (d) {
                                    var depName = [d.first_name, d.last_name].filter(Boolean).join(' ') || d.fullname || d.name || 'Co-Traveler';
                                    var depService = d.package || t.package || 'Full Support';
                                    var depPrice;

                                    // Use saved price if invoice is locked
                                    if (invoiceLocked && savedItems.length > 0) {
                                        var savedDep = savedItems.find(function (item) { return item.type === 'co-traveler' && item.id == d.id; });
                                        depPrice = savedDep ? parseFloat(savedDep.price) : getPriceFromPackage(depService);
                                    } else {
                                        depPrice = parseFloat(d.price) > 0 ? parseFloat(d.price) : getPriceFromPackage(depService);
                                    }

                                    subtotal += depPrice;
                                    travelers.push({
                                        name: depName,
                                        type: 'Co-Traveler',
                                        service: depService,
                                        visa_type: d.visa_type || t.visa_type || '',
                                        visa_country: t.visa_country || '',
                                        price: depPrice
                                    });
                                });
                            }

                            // Use saved invoice data if exists, otherwise calculate
                            var discountType, discountValue, discount, total;

                            if (invoiceLocked && savedInvoice) {
                                subtotal = parseFloat(savedInvoice.subtotal) || subtotal;
                                discountType = savedInvoice.discount_type || 'none';
                                discountValue = parseFloat(savedInvoice.discount_value) || 0;
                                discount = parseFloat(savedInvoice.discount_amount) || 0;
                                total = parseFloat(savedInvoice.total) || (subtotal - discount);
                            } else {
                                discountType = t.discount_type || 'none';
                                discountValue = parseFloat(t.discount_value) || 0;
                                discount = calcDiscount(subtotal, discountType, discountValue);
                                total = subtotal - discount;
                            }

                            var addr = [t.address_line1, t.address_line2, t.city, t.county, t.postcode].filter(Boolean).join(', ');

                            return {
                                id: t.id,
                                invoice_number: t.invoice_number || 'INV-' + String(t.id).padStart(4, '0'),
                                customer_name: mainName,
                                email: t.email || '',
                                address: addr,
                                invoice_date: t.created_at || '',
                                due_date: calcDueDate(t.created_at),
                                subtotal: subtotal,
                                discount: discount,
                                discount_type: discountType,
                                discount_value: discountValue,
                                total_amount: total,
                                invoice_locked: invoiceLocked,
                                payment_status: t.payment_status || 'Unpaid',
                                refund_amount: parseFloat(t.refund_amount) || 0,
                                visa_country: t.visa_country || '',
                                visa_type: t.visa_type || '',
                                package: t.package || '',
                                travelers: travelers,
                                traveler_count: travelers.length,
                                raw: t
                            };
                        });
                        console.log('Processed ' + allData.length + ' invoices');
                        applyFilters();
                    } else {
                        console.log('No data or error:', res);
                        showEmpty();
                    }
                }).fail(function (xhr, status, error) {
                    console.error('Load error:', xhr.responseText);
                    $('#loadingState').hide();
                    $('#emptyState').show();
                    if (xhr.status === 401 || xhr.status === 403) {
                        VaultAuth.logout();
                    }
                });
            }

            function calcDueDate(d) {
                if (!d) return '';
                try {
                    var date = new Date(d);
                    if (isNaN(date.getTime())) return ''; // Invalid date
                    date.setDate(date.getDate() + 7);
                    return date.toISOString().split('T')[0];
                } catch (e) {
                    console.warn('Invalid date:', d);
                    return '';
                }
            }

            function applyFilters() {
                filtered = allData.slice();
                var from = $('#fromDate').val(), to = $('#toDate').val(), quick = $('#quickFilter').val();
                if (quick !== 'all') {
                    if (from) filtered = filtered.filter(function (i) { return i.invoice_date >= from; });
                    if (to) filtered = filtered.filter(function (i) { return i.invoice_date <= to; });
                }
                var status = $('#statusFilter').val();
                if (status !== 'all') filtered = filtered.filter(function (i) { return i.payment_status === status; });
                var search = $('#searchInput').val().toLowerCase().trim();
                if (search) filtered = filtered.filter(function (i) {
                    return i.invoice_number.toLowerCase().indexOf(search) >= 0 ||
                        i.customer_name.toLowerCase().indexOf(search) >= 0 ||
                        (i.email && i.email.toLowerCase().indexOf(search) >= 0);
                });
                filtered.sort(function (a, b) {
                    var va = a[sortCol], vb = b[sortCol];
                    if (sortCol === 'total_amount' || sortCol === 'refund_amount') { va = parseFloat(va) || 0; vb = parseFloat(vb) || 0; }
                    else { va = (va || '').toString().toLowerCase(); vb = (vb || '').toString().toLowerCase(); }
                    if (va < vb) return sortDir === 'asc' ? -1 : 1;
                    if (va > vb) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });
                page = 1;
                render();
                updateSummary();
            }

            function render() {
                var tbody = $('#tableBody');
                tbody.empty();
                var total = filtered.length, pages = Math.ceil(total / perPage) || 1;
                var start = (page - 1) * perPage, end = Math.min(start + perPage, total);
                var pageData = filtered.slice(start, end);
                if (pageData.length === 0) { showEmpty(); return; }
                $('#emptyState').hide();
                pageData.forEach(function (inv) {
                    var statusCls = inv.payment_status === 'Paid' ? 'paid' : inv.payment_status === 'Full Refund' ? 'full-refund' : inv.payment_status === 'Partial Refund' ? 'partial-refund' : 'unpaid';
                    var statusIcon = inv.payment_status === 'Paid' ? 'fa-check-circle' : inv.payment_status === 'Full Refund' ? 'fa-undo' : inv.payment_status === 'Partial Refund' ? 'fa-undo-alt' : 'fa-clock';

                    // Build travelers list HTML
                    var travelersHtml = '';
                    inv.travelers.forEach(function (trav, idx) {
                        var typeClass = trav.type === 'Main' ? 'main-traveler' : 'co-traveler';
                        var typeLabel = trav.type === 'Main' ? '<span class="traveler-badge main">Main</span>' : '<span class="traveler-badge co">Co-Traveler</span>';
                        var travPrice = parseFloat(trav.price) || 0;
                        travelersHtml += '<div class="traveler-row ' + typeClass + '">' +
                            '<div class="traveler-name">' + trav.name + ' ' + typeLabel + ' <span class="traveler-price">£' + travPrice.toFixed(2) + '</span></div>' +
                            '<div class="traveler-service"><i class="fas fa-briefcase"></i> ' + trav.service + '</div>' +
                            (trav.visa_country ? '<div class="traveler-visa"><i class="fas fa-globe"></i> ' + trav.visa_type + ' - ' + trav.visa_country + '</div>' : '') +
                            '</div>';
                    });

                    tbody.append('<tr>' +
                        '<td><span class="invoice-num">' + inv.invoice_number + '</span></td>' +
                        '<td><div class="customer-info"><div class="name">' + inv.customer_name + '</div>' +
                        (inv.email ? '<div class="email">' + inv.email + '</div>' : '') +
                        '<div class="traveler-count"><i class="fas fa-users"></i> ' + inv.traveler_count + ' traveler(s)</div></div></td>' +
                        '<td><div class="travelers-list">' + travelersHtml + '</div></td>' +
                        '<td>' + formatDate(inv.invoice_date) + '</td>' +
                        '<td><div class="amount-breakdown"><span class="amount-total">£' + inv.total_amount.toFixed(2) + '</span>' +
                        (inv.discount > 0 ? '<div class="amount-discount"><i class="fas fa-tag"></i> -£' + inv.discount.toFixed(2) + ' (' + (inv.discount_type === 'percentage' ? inv.discount_value + '%' : '£' + inv.discount_value) + ')</div>' : '') +
                        '<div class="amount-subtotal">Subtotal: £' + inv.subtotal.toFixed(2) + '</div></div></td>' +
                        '<td>' + (inv.payment_status === 'Full Refund' ? '<span class="refund-amount full">-£' + inv.total_amount.toFixed(2) + '</span>' :
                            inv.payment_status === 'Partial Refund' ? '<span class="refund-amount partial">-£' + (parseFloat(inv.refund_amount) || 0).toFixed(2) + '</span>' :
                                '<span class="no-refund">-</span>') + '</td>' +
                        '<td><span class="status-badge ' + statusCls + '"><i class="fas ' + statusIcon + '"></i> ' + inv.payment_status + '</span></td>' +
                        '<td><div class="action-btns">' +
                        '<button class="view-btn" onclick="viewInvoice(' + inv.id + ')"><i class="fas fa-eye"></i> View</button>' +
                        '<button class="pdf-btn" onclick="downloadPDF(' + inv.id + ')"><i class="fas fa-file-pdf"></i></button>' +
                        '</div></td>' +
                        '</tr>');
                });
                $('#paginationInfo').text('Showing ' + (total > 0 ? start + 1 : 0) + '-' + end + ' of ' + total);
                $('#pageInfo').text('Page ' + page + ' of ' + pages);
                $('#prevBtn').prop('disabled', page <= 1);
                $('#nextBtn').prop('disabled', page >= pages);
            }

            function showEmpty() {
                $('#tableBody').empty();
                $('#emptyState').show();
                $('#paginationInfo').text('Showing 0-0 of 0');
                $('#pageInfo').text('Page 1 of 1');
                $('#prevBtn').prop('disabled', true);
                $('#nextBtn').prop('disabled', true);
            }

            function formatDate(d) {
                if (!d) return '-';
                var date = new Date(d);
                return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            }

            function updateSummary() {
                var count = filtered.length;
                var revenue = filtered.reduce(function (s, i) { return s + i.total_amount; }, 0);
                var paid = filtered.filter(function (i) { return i.payment_status === 'Paid'; }).reduce(function (s, i) { return s + i.total_amount; }, 0);
                var unpaid = filtered.filter(function (i) { return i.payment_status !== 'Paid' && i.payment_status !== 'Full Refund' && i.payment_status !== 'Partial Refund'; }).reduce(function (s, i) { return s + i.total_amount; }, 0);
                var fullRefund = filtered.filter(function (i) { return i.payment_status === 'Full Refund'; }).reduce(function (s, i) { return s + i.total_amount; }, 0);
                var partialRefund = filtered.filter(function (i) { return i.payment_status === 'Partial Refund'; }).reduce(function (s, i) { return s + (parseFloat(i.refund_amount) || 0); }, 0);
                $('#totalCount').text(count);
                $('#totalRevenue').text('£' + revenue.toFixed(2));
                $('#paidAmount').text('£' + paid.toFixed(2));
                $('#unpaidAmount').text('£' + unpaid.toFixed(2));
                $('#fullRefundAmount').text('£' + fullRefund.toFixed(2));
                $('#partialRefundAmount').text('£' + partialRefund.toFixed(2));
            }

            function bindEvents() {
                // Live filter on quick filter change
                $('#quickFilter').on('change', function () {
                    var v = $(this).val(), today = new Date(), from, to;
                    if (v === 'today') { from = to = today; }
                    else if (v === 'week') { from = new Date(today); from.setDate(today.getDate() - today.getDay()); to = new Date(from); to.setDate(from.getDate() + 6); }
                    else if (v === 'month') { from = new Date(today.getFullYear(), today.getMonth(), 1); to = new Date(today.getFullYear(), today.getMonth() + 1, 0); }
                    else if (v === 'lastmonth') { from = new Date(today.getFullYear(), today.getMonth() - 1, 1); to = new Date(today.getFullYear(), today.getMonth(), 0); }
                    else if (v === 'year') { from = new Date(today.getFullYear(), 0, 1); to = new Date(today.getFullYear(), 11, 31); }
                    else { $('#fromDate').val(''); $('#toDate').val(''); applyFilters(); return; }
                    $('#fromDate').val(from.toISOString().split('T')[0]);
                    $('#toDate').val(to.toISOString().split('T')[0]);
                    applyFilters();
                });

                // Live filter on date change
                $('#fromDate, #toDate').on('change', function () {
                    applyFilters();
                });

                // Live filter on status change
                $('#statusFilter').on('change', function () {
                    applyFilters();
                });

                // Live search with debounce
                var searchTimeout;
                $('#searchInput').on('input', function () {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function () {
                        applyFilters();
                    }, 300);
                });

                // Reset button
                $('#resetBtn').on('click', function () {
                    $('#fromDate').val(''); $('#toDate').val(''); $('#quickFilter').val('all'); $('#statusFilter').val('all'); $('#searchInput').val('');
                    applyFilters();
                });

                // Sorting
                $('th[data-sort]').on('click', function () {
                    var col = $(this).data('sort');
                    if (sortCol === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                    else { sortCol = col; sortDir = 'asc'; }
                    $('th[data-sort]').removeClass('sorted').find('i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
                    $(this).addClass('sorted').find('i').removeClass('fa-sort').addClass(sortDir === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                    applyFilters();
                });

                // Pagination
                $('#prevBtn').on('click', function () { if (page > 1) { page--; render(); } });
                $('#nextBtn').on('click', function () { var pages = Math.ceil(filtered.length / perPage); if (page < pages) { page++; render(); } });

                // Export CSV
                $('#exportBtn').on('click', exportCSV);

                // Save All Invoices
                $('#saveAllInvoicesBtn').on('click', function () {
                    var btn = $(this);
                    if (!confirm('This will save invoice data (prices, totals) for all travelers that don\'t have saved invoices yet. Continue?')) {
                        return;
                    }
                    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');

                    VaultAuth.apiCall({
                        url: VaultAuth.API_BASE_URL + '/travelers/save-all-invoices',
                        method: 'POST'
                    }).done(function (res) {
                        if (res.status === 'success') {
                            showToast(res.message, 'success');
                            // Reload the page to show updated data
                            location.reload();
                        } else {
                            showToast(res.message || 'Error saving invoices', 'error');
                        }
                        btn.prop('disabled', false).html('<i class="fas fa-save"></i> Save All Invoices');
                    }).fail(function (xhr) {
                        console.error('Save all invoices error:', xhr.responseText);
                        showToast('Error saving invoices', 'error');
                        btn.prop('disabled', false).html('<i class="fas fa-save"></i> Save All Invoices');
                        if (xhr.status === 401 || xhr.status === 403) {
                            VaultAuth.logout();
                        }
                    });
                });
            }

            var currentInvoice = null;

            window.viewInvoice = function (id) {
                var inv = allData.find(function (i) { return i.id == id; });
                if (!inv) return;

                currentInvoice = inv;
                $('#modalTitle').text('Invoice ' + inv.invoice_number);
                $('#invoiceModalBody').html(generateModalInvoice(inv));
                $('#invoiceModal').addClass('active');
            };

            // Close modal events
            $(document).on('click', '#modalCloseBtn', function () {
                $('#invoiceModal').removeClass('active');
                currentInvoice = null;
            });

            $(document).on('click', '#invoiceModal', function (e) {
                if ($(e.target).is('#invoiceModal')) {
                    $('#invoiceModal').removeClass('active');
                    currentInvoice = null;
                }
            });

            // Download PDF from modal
            $(document).on('click', '#modalDownloadBtn', function () {
                if (currentInvoice) {
                    downloadPDF(currentInvoice.id);
                }
            });

            // Email from modal
            $(document).on('click', '#modalEmailBtn', function () {
                if (currentInvoice && currentInvoice.email) {
                    if (confirm('Send invoice to ' + currentInvoice.email + '?')) {
                        showToast('Email sent to ' + currentInvoice.email, 'success');
                    }
                } else {
                    showToast('No email address available', 'warning');
                }
            });

            // Generate invoice HTML for modal
            function generateModalInvoice(inv) {
                var statusCls = inv.payment_status === 'Paid' ? 'paid' : inv.payment_status === 'Full Refund' ? 'full-refund' : inv.payment_status === 'Partial Refund' ? 'partial-refund' : 'unpaid';
                var statusText = inv.payment_status === 'Paid' ? '✓ PAID' : inv.payment_status === 'Full Refund' ? '↩ FULL REFUND' : inv.payment_status === 'Partial Refund' ? '↩ PARTIAL REFUND' : 'UNPAID';
                var items = '';

                inv.travelers.forEach(function (trav) {
                    var typeLabel = trav.type === 'Main' ? '' : ' (Co-Traveler)';
                    items += '<tr><td class="item-desc">' + trav.name + typeLabel + ' - ' + trav.service + '<br><small>' + trav.visa_type + ' - ' + trav.visa_country + '</small></td><td style="text-align:center">1</td><td style="text-align:right">£' + trav.price.toFixed(2) + '</td><td style="text-align:right">£' + trav.price.toFixed(2) + '</td></tr>';
                });

                var refundInfo = '';
                if (inv.payment_status === 'Full Refund') {
                    refundInfo = '<div class="invoice-total-row refund"><span>Full Refund:</span><span>-£' + inv.total_amount.toFixed(2) + '</span></div>';
                } else if (inv.payment_status === 'Partial Refund' && inv.refund_amount) {
                    refundInfo = '<div class="invoice-total-row refund"><span>Partial Refund:</span><span>-£' + parseFloat(inv.refund_amount).toFixed(2) + '</span></div>';
                }

                var footerMsg = inv.payment_status === 'Paid' ? '<p class="paid-msg">Payment has been received. Thank you!</p>' :
                    inv.payment_status === 'Full Refund' ? '<p class="refund-msg">A full refund has been processed for this invoice.</p>' :
                        inv.payment_status === 'Partial Refund' ? '<p class="refund-msg">A partial refund has been processed for this invoice.</p>' :
                            '<p>Payment is due within 7 days.</p>';

                return '<div class="invoice-container">' +
                    '<div class="invoice-header">' +
                    '<div class="invoice-logo"><img src="https://www.visad.co.uk/wp-content/uploads/2025/05/new-logo.png" alt="Logo"><h1 class="invoice-title">Invoice</h1></div>' +
                    '<div class="invoice-company"><div class="invoice-company-name">iWebron Limited, London</div><p>7 Bell Yard</p><p>London WC2A 2JR</p><p>+44 2080508848</p><p>support@visad.co.uk</p></div>' +
                    '</div>' +
                    '<div class="invoice-number-box"><div class="invoice-number-inner"><div class="invoice-number-label">Invoice Number</div><div class="invoice-number-value">' + inv.invoice_number + '</div></div></div>' +
                    '<div class="invoice-info">' +
                    '<div class="invoice-billto"><h3>Bill To:</h3><div class="cust-name">' + inv.customer_name + '</div>' + (inv.address ? '<p>' + inv.address + '</p>' : '') + (inv.email ? '<p>' + inv.email + '</p>' : '') + '</div>' +
                    '<div class="invoice-meta">' +
                    '<div class="invoice-meta-row"><span class="invoice-meta-label">Invoice Date:</span><span class="invoice-meta-value">' + formatDate(inv.invoice_date) + '</span></div>' +
                    '<div class="invoice-meta-row"><span class="invoice-meta-label">Due Date:</span><span class="invoice-meta-value">' + formatDate(inv.due_date) + '</span></div>' +
                    '<div class="invoice-meta-row"><span class="invoice-meta-label">Total:</span><span class="invoice-meta-value">£' + inv.total_amount.toFixed(2) + '</span></div>' +
                    '<div class="invoice-meta-row"><span class="invoice-meta-label">Status:</span><span class="invoice-meta-value"><span class="invoice-status ' + statusCls + '">' + statusText + '</span></span></div>' +
                    '</div>' +
                    '</div>' +
                    '<table class="invoice-table"><thead><tr><th>Description</th><th style="text-align:center">Units</th><th style="text-align:right">Price</th><th style="text-align:right">Amount</th></tr></thead><tbody>' + items + '</tbody></table>' +
                    '<div class="invoice-totals">' +
                    '<div class="invoice-total-row"><span>Subtotal:</span><span>£' + inv.subtotal.toFixed(2) + '</span></div>' +
                    (inv.discount > 0 ? '<div class="invoice-total-row discount"><span>Discount (' + (inv.discount_type === 'percentage' ? inv.discount_value + '%' : '£' + inv.discount_value + ' fixed') + '):</span><span>-£' + inv.discount.toFixed(2) + '</span></div>' : '') +
                    '<div class="invoice-total-row final"><span>Total:</span><span>£' + inv.total_amount.toFixed(2) + '</span></div>' +
                    refundInfo +
                    '</div>' +
                    '<div class="invoice-footer"><p>Thank you for your business!</p>' + footerMsg + '<p>For questions, contact us at support@visad.co.uk</p></div>' +
                    '</div>';
            }

            window.downloadPDF = function (id) {
                var inv = allData.find(function (i) { return i.id == id; });
                if (!inv) return;
                showToast('Generating PDF...', 'success');
                var html = generateInvoiceHTML(inv);
                var iframe = document.createElement('iframe');
                iframe.style.cssText = 'position:absolute;left:-9999px;width:210mm;height:297mm;';
                document.body.appendChild(iframe);
                iframe.contentDocument.write(html);
                iframe.contentDocument.close();
                setTimeout(function () {
                    html2canvas(iframe.contentDocument.body, { scale: 2, useCORS: true, backgroundColor: '#1e293b' }).then(function (canvas) {
                        var jsPDF = window.jspdf.jsPDF;
                        var pdf = new jsPDF('p', 'mm', 'a4');
                        var imgData = canvas.toDataURL('image/png');
                        var pdfW = pdf.internal.pageSize.getWidth();
                        var pdfH = (canvas.height * pdfW) / canvas.width;
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfW, Math.min(pdfH, pdf.internal.pageSize.getHeight()));
                        pdf.save(inv.invoice_number + '_' + inv.customer_name.replace(/\s+/g, '_') + '.pdf');
                        document.body.removeChild(iframe);
                        showToast('PDF downloaded!', 'success');
                    });
                }, 500);
            };

            function generateInvoiceHTML(inv) {
                var t = inv.raw;
                var statusCls = inv.payment_status === 'Paid' ? 'paid' : inv.payment_status === 'Full Refund' ? 'full-refund' : inv.payment_status === 'Partial Refund' ? 'partial-refund' : 'unpaid';
                var statusText = inv.payment_status === 'Paid' ? '✓ PAID' : inv.payment_status === 'Full Refund' ? '↩ FULL REFUND' : inv.payment_status === 'Partial Refund' ? '↩ PARTIAL REFUND' : 'UNPAID';
                var items = '';

                // Use travelers array for items
                inv.travelers.forEach(function (trav) {
                    var typeLabel = trav.type === 'Main' ? '' : ' (Co-Traveler)';
                    items += '<tr><td>' + trav.name + typeLabel + ' - ' + trav.service + '<br><small style="color:#94a3b8">' + trav.visa_type + ' - ' + trav.visa_country + '</small></td><td style="text-align:center">1</td><td style="text-align:right">£' + trav.price.toFixed(2) + '</td><td style="text-align:right">£' + trav.price.toFixed(2) + '</td></tr>';
                });

                var refundRow = '';
                if (inv.payment_status === 'Full Refund') {
                    refundRow = '<div class="total-row refund"><span>Full Refund:</span><span>-£' + inv.total_amount.toFixed(2) + '</span></div>';
                } else if (inv.payment_status === 'Partial Refund' && inv.refund_amount) {
                    refundRow = '<div class="total-row refund"><span>Partial Refund:</span><span>-£' + parseFloat(inv.refund_amount).toFixed(2) + '</span></div>';
                }

                var footerMsg = inv.payment_status === 'Paid' ? '<p class="payment-received">Payment has been received. Thank you!</p>' :
                    inv.payment_status === 'Full Refund' ? '<p class="refund-msg">A full refund has been processed.</p>' :
                        inv.payment_status === 'Partial Refund' ? '<p class="refund-msg">A partial refund has been processed.</p>' :
                            '<p>Payment is due within 7 days.</p>';

                return '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Invoice ' + inv.invoice_number + '</title><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:"Plus Jakarta Sans",sans-serif;background:#1e293b;padding:20px;color:#f1f5f9}.container{max-width:800px;margin:0 auto;background:#1e293b;padding:40px;border-radius:12px}.header{display:flex;justify-content:space-between;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid #334155}.logo img{width:120px}.invoice-title{font-size:28px;font-weight:300;margin-top:10px}.company-info{text-align:right}.company-name{font-weight:700;color:#818cf8;font-size:16px;margin-bottom:8px}.company-info p{font-size:12px;color:#94a3b8;margin:2px 0}.inv-number-section{text-align:center;margin:30px 0}.inv-number-box{display:inline-block;border:2px solid #f1f5f9;border-radius:8px;padding:12px 30px}.inv-number-label{font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px}.inv-number{font-size:20px;font-weight:700;font-family:"JetBrains Mono",monospace}.info-section{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-bottom:30px}.bill-to h3{font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}.bill-to .cust-name{font-size:16px;font-weight:700;margin-bottom:8px}.bill-to p{font-size:13px;color:#94a3b8;margin:2px 0}.inv-details{text-align:right}.detail-row{display:flex;justify-content:flex-end;margin-bottom:8px;font-size:13px}.detail-label{color:#94a3b8;margin-right:15px}.detail-value{font-weight:600;min-width:100px;text-align:right}.status-badge{display:inline-block;padding:4px 10px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase}.status-badge.paid{background:rgba(16,185,129,0.2);color:#10b981}.status-badge.unpaid{background:rgba(244,63,94,0.2);color:#f43f5e}.status-badge.full-refund{background:rgba(239,68,68,0.2);color:#f87171}.status-badge.partial-refund{background:rgba(245,158,11,0.2);color:#fbbf24}table{width:100%;border-collapse:collapse;margin-bottom:25px}th{padding:12px 10px;text-align:left;font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;border-bottom:2px solid #334155}td{padding:15px 10px;font-size:13px;border-bottom:1px solid #334155}.totals{margin-left:auto;width:280px}.total-row{display:flex;justify-content:space-between;padding:10px 0;font-size:13px;color:#94a3b8}.total-row.discount{color:#10b981;background:rgba(16,185,129,0.1);padding:8px 12px;border-radius:6px;margin:5px 0}.total-row.refund{color:#f59e0b;background:rgba(245,158,11,0.1);padding:8px 12px;border-radius:6px;margin:5px 0}.total-row.final{border-top:2px solid #f1f5f9;padding-top:15px;margin-top:10px;font-size:18px;font-weight:700;color:#f1f5f9}.footer{margin-top:40px;padding-top:20px;border-top:1px solid #334155;text-align:center;color:#94a3b8;font-size:12px}.footer p{margin:5px 0}.payment-received{color:#10b981;font-weight:600}.refund-msg{color:#f59e0b;font-weight:600}</style></head><body><div class="container"><div class="header"><div class="logo"><img src="https://www.visad.co.uk/wp-content/uploads/2025/05/new-logo.png" alt="Logo"><h1 class="invoice-title">Invoice</h1></div><div class="company-info"><div class="company-name">iWebron Limited, London</div><p>7 Bell Yard</p><p>London WC2A 2JR</p><p>+44 2080508848</p><p>support@visad.co.uk</p></div></div><div class="inv-number-section"><div class="inv-number-box"><div class="inv-number-label">Invoice Number</div><div class="inv-number">' + inv.invoice_number + '</div></div></div><div class="info-section"><div class="bill-to"><h3>Bill To:</h3><div class="cust-name">' + inv.customer_name + '</div>' + (inv.address ? '<p>' + inv.address + '</p>' : '') + (inv.email ? '<p>' + inv.email + '</p>' : '') + '</div><div class="inv-details"><div class="detail-row"><span class="detail-label">Invoice Date:</span><span class="detail-value">' + formatDate(inv.invoice_date) + '</span></div><div class="detail-row"><span class="detail-label">Due Date:</span><span class="detail-value">' + formatDate(inv.due_date) + '</span></div><div class="detail-row"><span class="detail-label">Total Amount:</span><span class="detail-value">£' + inv.total_amount.toFixed(2) + '</span></div><div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value"><span class="status-badge ' + statusCls + '">' + statusText + '</span></span></div></div></div><table><thead><tr><th>Description</th><th style="text-align:center">Units</th><th style="text-align:right">Price</th><th style="text-align:right">Amount</th></tr></thead><tbody>' + items + '</tbody></table><div class="totals"><div class="total-row"><span>Subtotal:</span><span>£' + inv.subtotal.toFixed(2) + '</span></div>' + (inv.discount > 0 ? '<div class="total-row discount"><span>Discount (' + (inv.discount_type === 'percentage' ? inv.discount_value + '%' : '£' + inv.discount_value + ' off') + '):</span><span>-£' + inv.discount.toFixed(2) + '</span></div>' : '') + '<div class="total-row final"><span>Total:</span><span>£' + inv.total_amount.toFixed(2) + '</span></div>' + refundRow + '</div><div class="footer"><p>Thank you for your business!</p>' + footerMsg + '<p>For questions, contact us at support@visad.co.uk</p></div></div></body></html>';
            }

            function exportCSV() {
                if (filtered.length === 0) { showToast('No data to export', 'warning'); return; }
                var headers = ['Invoice #', 'Customer', 'Email', 'Invoice Date', 'Due Date', 'Subtotal', 'Discount Type', 'Discount Value', 'Discount Amount', 'Total', 'Refund Amount', 'Status'];
                var rows = filtered.map(function (i) {
                    var refundAmt = 0;
                    if (i.payment_status === 'Full Refund') {
                        refundAmt = i.total_amount;
                    } else if (i.payment_status === 'Partial Refund') {
                        refundAmt = parseFloat(i.refund_amount) || 0;
                    }
                    return [
                        i.invoice_number,
                        i.customer_name,
                        i.email || '',
                        i.invoice_date,
                        i.due_date,
                        i.subtotal.toFixed(2),
                        i.discount_type || 'none',
                        i.discount_value || 0,
                        i.discount.toFixed(2),
                        i.total_amount.toFixed(2),
                        refundAmt.toFixed(2),
                        i.payment_status
                    ];
                });
                var csv = headers.join(',') + '\n';
                rows.forEach(function (r) { csv += r.map(function (c) { return '"' + c + '"'; }).join(',') + '\n'; });
                var blob = new Blob([csv], { type: 'text/csv' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'invoices_' + new Date().toISOString().split('T')[0] + '.csv';
                link.click();
                showToast('CSV exported!', 'success');
            }

            function showToast(msg, type) {
                var icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-exclamation-triangle';
                var toast = $('<div class="toast ' + type + '"><i class="fas ' + icon + '"></i> ' + msg + '</div>');
                $('body').append(toast);
                setTimeout(function () { toast.fadeOut(300, function () { $(this).remove(); }); }, 3000);
            }
        });
    </script>
</body>

</html>